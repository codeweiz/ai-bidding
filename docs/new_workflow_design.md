# ä¼˜åŒ–åçš„AIæŠ•æ ‡LangGraphå·¥ä½œæµè®¾è®¡

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

åŸºäºæ‚¨çš„éœ€æ±‚ï¼Œæˆ‘ä»¬é‡æ–°è®¾è®¡äº†LangGraphå·¥ä½œæµï¼Œå®ç°äº†ä»¥ä¸‹æ ¸å¿ƒæ”¹è¿›ï¼š

### 1. å±‚æ¬¡åŒ–ç›®å½•éå†
- **ç« èŠ‚æ ‘ç»“æ„**: ä½¿ç”¨`SectionNode`ç±»æ„å»ºçœŸæ­£çš„æ ‘å½¢ç»“æ„
- **å¶å­èŠ‚ç‚¹ä¼˜å…ˆ**: å…ˆç”Ÿæˆæœ€åº•å±‚çš„å…·ä½“å†…å®¹
- **çˆ¶èŠ‚ç‚¹æ€»ç»“**: åŸºäºå­èŠ‚ç‚¹å†…å®¹ç”Ÿæˆä¸Šçº§æ€»ç»“

### 2. ä¸“ä¸šåŒ–Promptæ¨¡æ¿
- **IPTVé¢†åŸŸä¸“å®¶**: ä½¿ç”¨æ‚¨æä¾›çš„ä¸“ä¸šprompt
- **ç´§æ‰£æ‹›æ ‡éœ€æ±‚**: é¿å…è‡ªç”±å‘æŒ¥å’Œå†…å®¹æ‰©æ•£
- **æŠ€æœ¯æ¶æ„å›¾**: æ”¯æŒPlantUML/Mermaidä»£ç ç”Ÿæˆ

## ğŸ”„ æ–°å·¥ä½œæµèŠ‚ç‚¹

### èŠ‚ç‚¹1: è§£ææ‹›æ ‡æ–‡æ¡£ (`parse_document`)
```python
è¾“å…¥: æ‹›æ ‡æ–‡æ¡£å†…å®¹
å¤„ç†: æ¸…ç†å’Œé¢„å¤„ç†æ–‡æ¡£å†…å®¹
è¾“å‡º: æ ‡å‡†åŒ–çš„æ–‡æ¡£å†…å®¹
```

### èŠ‚ç‚¹2: ç”ŸæˆIPTVæçº² (`generate_outline`)
```python
è¾“å…¥: æ‹›æ ‡æ–‡æ¡£å†…å®¹
Prompt: æ‚¨æä¾›çš„IPTVä¸“å®¶prompt
è¾“å‡º: å±‚æ¬¡åŒ–çš„markdownæçº²
```

### èŠ‚ç‚¹3: æ„å»ºç« èŠ‚æ ‘ (`build_section_tree`)
```python
è¾“å…¥: markdownæçº²
å¤„ç†: è§£æä¸ºSectionNodeæ ‘ç»“æ„
è¾“å‡º: å±‚æ¬¡åŒ–çš„ç« èŠ‚æ ‘ + æ‰å¹³ç« èŠ‚åˆ—è¡¨
```

### èŠ‚ç‚¹4: ç”Ÿæˆå¶å­èŠ‚ç‚¹å†…å®¹ (`generate_leaf_content`)
```python
è¾“å…¥: ç« èŠ‚æ ‘ + æ‹›æ ‡æ–‡æ¡£
å¤„ç†: 
  1. è¯†åˆ«æ‰€æœ‰å¶å­èŠ‚ç‚¹
  2. ä½¿ç”¨IPTVä¸“ä¸špromptç”Ÿæˆå†…å®¹
  3. æ”¯æŒmermaidå›¾è¡¨ä»£ç 
è¾“å‡º: æ‰€æœ‰å¶å­èŠ‚ç‚¹çš„å…·ä½“å†…å®¹
```

### èŠ‚ç‚¹5: ç”Ÿæˆçˆ¶èŠ‚ç‚¹æ€»ç»“ (`generate_parent_summaries`)
```python
è¾“å…¥: å·²ç”Ÿæˆå†…å®¹çš„ç« èŠ‚æ ‘
å¤„ç†:
  1. ä»æœ€æ·±å±‚å¼€å§‹å‘ä¸Šéå†
  2. æ”¶é›†å­èŠ‚ç‚¹å†…å®¹
  3. ç”Ÿæˆæ€»ç»“æ€§ã€ä¸²è”æ€§æ–‡æ¡ˆ
è¾“å‡º: æ‰€æœ‰çˆ¶èŠ‚ç‚¹çš„æ€»ç»“å†…å®¹
```

### èŠ‚ç‚¹6: å·®å¼‚åŒ–å¤„ç† (`differentiate_content`)
```python
è¾“å…¥: å®Œæ•´çš„ç« èŠ‚æ ‘
å¤„ç†: å¯¹æ‰€æœ‰èŠ‚ç‚¹å†…å®¹è¿›è¡ŒLLMæ”¹å†™
è¾“å‡º: å·®å¼‚åŒ–åçš„å†…å®¹ï¼ˆ30-40%å·®å¼‚åº¦ï¼‰
```

## ğŸŒ³ ç« èŠ‚æ ‘ç»“æ„è®¾è®¡

### SectionNodeç±»
```python
class SectionNode:
    title: str              # ç« èŠ‚æ ‡é¢˜
    level: int              # å±‚çº§ï¼ˆ1,2,3,4...ï¼‰
    order: int              # é¡ºåºå·
    children: List[SectionNode]  # å­èŠ‚ç‚¹
    parent: SectionNode     # çˆ¶èŠ‚ç‚¹
    content: str            # ç”Ÿæˆçš„å†…å®¹
    is_generated: bool      # æ˜¯å¦å·²ç”Ÿæˆ
    is_leaf: bool           # æ˜¯å¦ä¸ºå¶å­èŠ‚ç‚¹
```

### æ ‘å½¢ç»“æ„ç¤ºä¾‹
```
æŠ€æœ¯æ–¹æ¡ˆ
â”œâ”€â”€ 1. ç³»ç»Ÿæ¶æ„è®¾è®¡
â”‚   â”œâ”€â”€ 1.1 æ€»ä½“æ¶æ„ (å¶å­)
â”‚   â”œâ”€â”€ 1.2 æŠ€æœ¯æ¶æ„
â”‚   â”‚   â”œâ”€â”€ 1.2.1 å‰ç«¯æ¶æ„ (å¶å­)
â”‚   â”‚   â””â”€â”€ 1.2.2 åç«¯æ¶æ„ (å¶å­)
â”‚   â””â”€â”€ 1.3 éƒ¨ç½²æ¶æ„ (å¶å­)
â”œâ”€â”€ 2. åŠŸèƒ½è®¾è®¡
â”‚   â”œâ”€â”€ 2.1 æ ¸å¿ƒåŠŸèƒ½ (å¶å­)
â”‚   â””â”€â”€ 2.2 æ‰©å±•åŠŸèƒ½ (å¶å­)
â””â”€â”€ 3. å®æ–½æ–¹æ¡ˆ
    â”œâ”€â”€ 3.1 å®æ–½è®¡åˆ’ (å¶å­)
    â””â”€â”€ 3.2 é£é™©æ§åˆ¶ (å¶å­)
```

## ğŸ“ ä¼˜åŒ–çš„Promptæ¨¡æ¿

### ç”Ÿæˆç›®å½•Prompt
```
æˆ‘çš„é¡¶å±‚ç›®æ ‡ï¼Œæ˜¯ç¼–å†™ä¸€ä»½æŠ•æ ‡æ–¹æ¡ˆçš„æŠ€æœ¯æ–¹æ¡ˆéƒ¨åˆ†ï¼›
ä½ éœ€è¦æ‰®æ¼”ä¸€ä½å¹¿ç”µIPTVé¢†åŸŸçš„è¡Œä¸šä¸“å®¶ï¼Œè§£å†³æ–¹æ¡ˆè¾¾äººï¼›
éœ€è¦æ³¨æ„ï¼Œåç»­æ‰€æœ‰çš„å·¥ä½œï¼Œéƒ½è¦ç´§å¯†å›´ç»•ä¸Šä¼ çš„æ‹›æ ‡æ–¹æ¡ˆï¼Œå°¤å…¶é¿å…å‡ºç°ç¼–å†™æ–¹æ¡ˆæ—¶è‡ªç”±å‘æŒ¥å’Œæ‰©æ•£çš„æƒ…å†µã€‚å› æ­¤ï¼Œä½ å§‹ç»ˆè¦è®°ä½è¿™ä»½æ–¹æ¡ˆçš„å†…å®¹ï¼›
ç„¶åï¼Œä½ è¾“å‡ºä¸€ä»½å®Œæ•´çš„æŠ•æ ‡æŠ€æœ¯æ–¹æ¡ˆçš„å®Œæ•´æçº²ï¼Œæçº²è¦æ±‚å®Œæ•´æ‰«æç”¨æˆ·éœ€æ±‚ï¼Œç»“æ„åŒ–å®‰æ’ç« èŠ‚å†…å®¹ï¼Œæçº²çš„å„å­ç« èŠ‚ä¸èƒ½æœ‰æ¼é¡¹ï¼›
ç”±äºå…¬å¸æœ‰å›ºå®šæ¨¡æ¿ï¼Œå› æ­¤æçº²ä¸è¦ç¼–æ’åŒ…å«"å”®å"ã€"éªŒæ”¶"å’Œ"è´¨é‡ä¿éšœ"ç›¸å…³çš„ç« èŠ‚ï¼›
è¾“å‡ºæçº²æ—¶ï¼Œä¸è¦åŠ è¯´æ˜æ€§æ–‡å­—ã€‚

æ‹›æ ‡å†…å®¹å¦‚ä¸‹ï¼š{æ‹›æ ‡æ–‡æ¡£å†…å®¹}
```

### ç”Ÿæˆæ­£æ–‡Prompt
```
æˆ‘çš„é¡¶å±‚ç›®æ ‡ï¼Œæ˜¯ç¼–å†™ä¸€ä»½æŠ•æ ‡æ–¹æ¡ˆçš„æŠ€æœ¯æ–¹æ¡ˆéƒ¨åˆ†ï¼›
ä½ éœ€è¦æ‰®æ¼”ä¸€ä½å¹¿ç”µIPTVé¢†åŸŸçš„è¡Œä¸šä¸“å®¶ï¼Œè§£å†³æ–¹æ¡ˆè¾¾äººï¼›
éœ€è¦æ³¨æ„ï¼Œåç»­æ‰€æœ‰çš„å·¥ä½œï¼Œéƒ½è¦ç´§å¯†å›´ç»•ä¸Šä¼ çš„æ‹›æ ‡æ–¹æ¡ˆï¼Œå°¤å…¶é¿å…å‡ºç°ç¼–å†™æ–¹æ¡ˆæ—¶è‡ªç”±å‘æŒ¥å’Œæ‰©æ•£çš„æƒ…å†µã€‚å› æ­¤ï¼Œä½ å§‹ç»ˆè¦è®°ä½è¿™ä»½æ–¹æ¡ˆçš„å†…å®¹ï¼›
ç¼–åˆ¶å†…å®¹æ—¶ï¼Œæ–¹æ¡ˆåº”å°½å¯èƒ½è´´åˆæ‹›æ ‡æ–¹æ¡ˆä¸­æåˆ°çš„éœ€æ±‚ç‚¹ï¼Œå›´ç»•éœ€æ±‚ç‚¹å±•å¼€è®¾è®¡æè¿°ï¼Œä½†ä¸è¦ç›´æ¥ç…§æŠ„åŸæ–‡ï¼›
æ¶‰åŠåˆ°æŠ€æœ¯å®ç°çš„æè¿°ï¼Œåº”è¯¥æ›´åŠ åé€»è¾‘æè¿°ï¼Œé¿å…æåˆ°éå¸¸å…·ä½“çš„æŠ€æœ¯æ ˆï¼›
æ¶‰åŠåˆ°éœ€è¦æ¶æ„è®¾è®¡çš„å†…å®¹ï¼Œåº”ç”¨plantuml(mermaid/Graphviz)çš„ä»£ç è¾“å‡ºæ¶æ„è®¾è®¡ï¼›
æ¶‰åŠåˆ°éœ€è¦ä¸šåŠ¡æµç¨‹æˆ–ç³»ç»Ÿæµç¨‹ã€æ—¶åºå›¾ç­‰å†…å®¹ï¼ŒåŒæ ·ç”¨plantuml(mermaid/Graphviz)çš„ä»£ç è¾“å‡ºæµç¨‹è®¾è®¡ã€‚

ç« èŠ‚æ ‡é¢˜å¦‚ä¸‹ï¼š{ç« èŠ‚æ ‡é¢˜}
æ‹›æ ‡å†…å®¹å¦‚ä¸‹ï¼š{æ‹›æ ‡æ–‡æ¡£å†…å®¹}
```

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. ç« èŠ‚æ ‘è§£æç®—æ³•
- æ”¯æŒmarkdownæ ¼å¼æ ‡é¢˜ï¼ˆ#, ##, ###, ####ï¼‰
- æ”¯æŒæ•°å­—ç¼–å·æ ¼å¼ï¼ˆ1., 1.1, 1.1.1ï¼‰
- æ”¯æŒç¼©è¿›æ ¼å¼è¯†åˆ«
- è‡ªåŠ¨æ„å»ºçˆ¶å­å…³ç³»

### 2. å¶å­èŠ‚ç‚¹è¯†åˆ«
```python
def get_all_leaf_nodes(self) -> List[SectionNode]:
    if self.is_leaf:
        return [self]
    
    leaf_nodes = []
    for child in self.children:
        leaf_nodes.extend(child.get_all_leaf_nodes())
    return leaf_nodes
```

### 3. é€’å½’å†…å®¹ç”Ÿæˆ
```python
async def _generate_node_summary_recursive(self, node: SectionNode, document_content: str):
    # å¶å­èŠ‚ç‚¹ç›´æ¥è¿”å›
    if node.is_leaf:
        return
    
    # å…ˆç¡®ä¿æ‰€æœ‰å­èŠ‚ç‚¹éƒ½æœ‰å†…å®¹
    for child in node.children:
        await self._generate_node_summary_recursive(child, document_content)
    
    # æ”¶é›†å­èŠ‚ç‚¹å†…å®¹å¹¶ç”Ÿæˆçˆ¶èŠ‚ç‚¹æ€»ç»“
    children_content = [f"### {child.title}\n{child.content}" for child in node.children if child.content]
    # ... ç”Ÿæˆæ€»ç»“
```

## ğŸ¯ é¢„æœŸæ•ˆæœ

### 1. å†…å®¹è´¨é‡æå‡
- **ä¸“ä¸šæ€§**: IPTVé¢†åŸŸä¸“å®¶çº§åˆ«çš„å†…å®¹
- **é’ˆå¯¹æ€§**: ç´§å¯†è´´åˆæ‹›æ ‡éœ€æ±‚ï¼Œæ— å†—ä½™å†…å®¹
- **é€»è¾‘æ€§**: å±‚æ¬¡æ¸…æ™°ï¼Œæ‰¿ä¸Šå¯ä¸‹

### 2. ç”Ÿæˆæ•ˆç‡ä¼˜åŒ–
- **å¹¶è¡Œå¤„ç†**: å¶å­èŠ‚ç‚¹å¯ä»¥å¹¶è¡Œç”Ÿæˆ
- **å¢é‡ç”Ÿæˆ**: æ”¯æŒå•ç‹¬é‡æ–°ç”ŸæˆæŸä¸ªç« èŠ‚
- **çŠ¶æ€æ¢å¤**: LangGraphæ”¯æŒä¸­æ–­æ¢å¤

### 3. å·®å¼‚åŒ–ä¿è¯
- **ç»“æ„å·®å¼‚**: ä¸åŒé¡¹ç›®çš„ç« èŠ‚ç»“æ„å¯èƒ½ä¸åŒ
- **å†…å®¹å·®å¼‚**: LLMæ”¹å†™ç¡®ä¿30-40%å·®å¼‚åº¦
- **è¡¨è¿°å·®å¼‚**: åŒä¹‰è¯æ›¿æ¢å’Œå¥å¼å˜æ¢

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. å¯åŠ¨å·¥ä½œæµ
```python
from backend.services.workflow_engine import workflow_engine
from backend.models.generation import WorkflowState

state = WorkflowState(
    project_id="project_001",
    current_step="start",
    document_content=document_content,
    enable_differentiation=True
)

final_state = await workflow_engine.run_workflow(state)
```

### 2. æ£€æŸ¥ç»“æœ
```python
if final_state.error:
    print(f"å·¥ä½œæµå¤±è´¥: {final_state.error}")
else:
    print(f"ç”Ÿæˆäº†{len(final_state.sections)}ä¸ªç« èŠ‚")
    for section in final_state.sections:
        print(f"- {section['title']} ({'å¶å­' if section['is_leaf'] else 'çˆ¶èŠ‚ç‚¹'})")
```

## ğŸ“Š æµ‹è¯•éªŒè¯

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯æ–°å·¥ä½œæµï¼š
```bash
python test_new_workflow.py
```

æµ‹è¯•å†…å®¹åŒ…æ‹¬ï¼š
- ç« èŠ‚æ ‘æ„å»ºæµ‹è¯•
- æ–‡æ¡£è§£ææµ‹è¯•  
- å®Œæ•´å·¥ä½œæµæµ‹è¯•
- å¶å­èŠ‚ç‚¹è¯†åˆ«æµ‹è¯•
- çˆ¶èŠ‚ç‚¹æ€»ç»“æµ‹è¯•

## ğŸ”® åç»­ä¼˜åŒ–æ–¹å‘

1. **å›¾è¡¨ç”Ÿæˆ**: é›†æˆPlantUML/Mermaidæ¸²æŸ“å¼•æ“
2. **æ¨¡æ¿ç®¡ç†**: æ”¯æŒå¤šç§æŠ•æ ‡æ¨¡æ¿
3. **è´¨é‡æ£€æŸ¥**: å¢åŠ å†…å®¹è´¨é‡è¯„ä¼°æœºåˆ¶
4. **å¹¶è¡Œä¼˜åŒ–**: å¶å­èŠ‚ç‚¹å¹¶è¡Œç”Ÿæˆ
5. **ç¼“å­˜æœºåˆ¶**: é¿å…é‡å¤ç”Ÿæˆç›¸åŒå†…å®¹
