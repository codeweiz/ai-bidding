# AI投标系统增强版使用指南

## 🎯 系统概述

AI投标系统增强版是基于原有系统的全面升级，实现了完全自动化的LangGraph工作流，具备以下核心特性：

### ✨ 新增功能特性

1. **全自动化LangGraph工作流** - 消除手动操作，端到端自动化
2. **持久化与状态恢复** - 服务重启后可继续执行任务
3. **内容校验与纠错** - 多层次验证，防止内容畸变
4. **异步任务处理** - Celery队列，支持重试机制
5. **Word格式输出** - 专业的OutputParser确保格式正确

### 🏗️ 技术架构升级

- **数据库**: PostgreSQL (持久化存储)
- **缓存**: Redis (消息队列和缓存)
- **任务队列**: Celery (异步处理)
- **监控**: Flower (任务监控)
- **工作流**: LangGraph (状态管理)

## 🚀 快速开始

### 1. 环境准备

确保系统已安装：
- Docker >= 20.0
- Docker Compose >= 2.0
- 至少 4GB 可用内存

### 2. 启动系统

```bash
# 使用增强版启动脚本
./start_enhanced.sh
```

启动后可访问：
- 后端API: http://localhost:8000
- 前端界面: http://localhost:7860
- Celery监控: http://localhost:5555
- API文档: http://localhost:8000/docs

### 3. 配置检查

访问健康检查接口确认所有服务正常：
```bash
curl http://localhost:8000/health
```

## 📋 全自动化工作流使用

### 方式一：API调用（推荐）

#### 1. 创建项目
```bash
curl -X POST "http://localhost:8000/api/projects/" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试项目",
    "description": "全自动化测试",
    "enable_differentiation": true
  }'
```

#### 2. 上传文档
```bash
curl -X POST "http://localhost:8000/api/documents/upload" \
  -F "file=@/path/to/bidding_document.pdf"
```

#### 3. 启动全自动化任务
```bash
curl -X POST "http://localhost:8000/api/tasks/" \
  -H "Content-Type: application/json" \
  -d '{
    "project_id": "your-project-id",
    "task_type": "full_workflow",
    "config": {
      "document_path": "/app/uploads/bidding_document.pdf",
      "enable_differentiation": true,
      "enable_validation": true,
      "project_name": "测试项目"
    }
  }'
```

#### 4. 监控任务进度
```bash
# 获取任务状态
curl "http://localhost:8000/api/tasks/{task_id}/status"

# 获取详细信息
curl "http://localhost:8000/api/tasks/{task_id}"
```

### 方式二：前端界面

1. 访问 http://localhost:7860
2. 在项目管理页面创建新项目
3. 上传招标文档
4. 点击"启动全自动化流程"
5. 在任务监控页面查看进度

## 🔧 高级功能

### 1. 任务管理

#### 查看所有任务
```bash
curl "http://localhost:8000/api/tasks/?limit=20&offset=0"
```

#### 重试失败任务
```bash
curl -X POST "http://localhost:8000/api/tasks/{task_id}/retry"
```

#### 取消运行中任务
```bash
curl -X POST "http://localhost:8000/api/tasks/{task_id}/cancel"
```

### 2. 检查点管理

#### 查看任务检查点
```bash
curl "http://localhost:8000/api/tasks/{task_id}/checkpoints"
```

#### 获取最新检查点
```bash
curl "http://localhost:8000/api/tasks/{task_id}/latest-checkpoint"
```

### 3. 内容校验配置

在任务配置中可以设置校验参数：
```json
{
  "config": {
    "enable_validation": true,
    "validation_level": "high",
    "max_retries": 3,
    "auto_correction": true
  }
}
```

### 4. 输出格式定制

配置Word文档输出格式：
```json
{
  "config": {
    "output_format": {
      "font_name": "宋体",
      "font_size": 12,
      "line_spacing": 1.5,
      "include_toc": true,
      "include_metadata": true
    }
  }
}
```

## 📊 监控和运维

### 1. Celery任务监控

访问 http://localhost:5555 查看：
- 任务执行状态
- 队列长度
- Worker状态
- 执行统计

### 2. 日志查看

```bash
# 查看所有服务日志
docker-compose -f docker-compose.enhanced.yml logs -f

# 查看特定服务日志
docker-compose -f docker-compose.enhanced.yml logs -f backend
docker-compose -f docker-compose.enhanced.yml logs -f celery-worker
```

### 3. 数据库管理

```bash
# 连接PostgreSQL
docker exec -it ai-bidding-postgres psql -U ai_bidding -d ai_bidding

# 查看任务表
SELECT id, status, progress, current_step FROM tasks ORDER BY created_at DESC LIMIT 10;
```

### 4. 性能优化

#### 调整Worker数量
```bash
# 修改docker-compose.enhanced.yml中的concurrency参数
command: celery -A backend.tasks.celery_app worker --loglevel=info --concurrency=4
```

#### 配置队列优先级
```bash
# 高优先级队列处理重要任务
command: celery -A backend.tasks.celery_app worker --queues=workflow_high,workflow,default
```

## 🔍 故障排除

### 常见问题

#### 1. 任务卡住不执行
- 检查Celery Worker状态
- 查看Redis连接
- 重启Worker服务

#### 2. 数据库连接失败
- 检查PostgreSQL服务状态
- 验证连接字符串
- 查看数据库日志

#### 3. 内容生成质量差
- 调整校验级别
- 检查LLM配置
- 查看校验报告

#### 4. Word文档格式异常
- 检查OutputParser配置
- 验证模板文件
- 查看生成日志

### 诊断命令

```bash
# 检查服务健康状态
curl http://localhost:8000/health

# 检查Celery连接
docker exec ai-bidding-celery-worker celery -A backend.tasks.celery_app inspect ping

# 检查数据库连接
docker exec ai-bidding-postgres pg_isready -U ai_bidding

# 检查Redis连接
docker exec ai-bidding-redis redis-cli ping
```

## 🔄 升级和迁移

### 从原版本升级

1. 备份现有数据
2. 停止原服务
3. 运行数据迁移脚本
4. 启动增强版服务

### 数据备份

```bash
# 备份数据库
docker exec ai-bidding-postgres pg_dump -U ai_bidding ai_bidding > backup.sql

# 备份文件
tar -czf files_backup.tar.gz uploads outputs
```

## 📈 最佳实践

### 1. 任务配置优化
- 根据文档复杂度调整超时时间
- 合理设置重试次数
- 启用适当的校验级别

### 2. 资源管理
- 监控内存使用情况
- 定期清理过期任务
- 优化Worker并发数

### 3. 安全考虑
- 定期更新依赖
- 配置访问控制
- 监控异常访问

## 🆘 技术支持

如遇到问题，请：
1. 查看相关日志
2. 检查系统状态
3. 参考故障排除指南
4. 提供详细错误信息

---

**注意**: 增强版系统需要更多资源，建议在生产环境中使用专用服务器部署。
